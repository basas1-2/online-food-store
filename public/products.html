<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Products - Food store</title>
  <link rel="stylesheet" href="style.css">
</head>
<body class="products-page">
<nav class="site-nav">
  <div class="nav-brand">Food store</div>
  <div>
    <a href="index.html">Home</a>
    <a id="navAdmin" href="admin.html" style="display:none">Admin</a>
    <a id="logoutBtn" href="#">Logout</a>
  </div>
</nav>

<div class="container">
  <h2>Available Products</h2>
  <div style="margin-bottom:12px">
    <input id="search" placeholder="Search products..." style="width:100%;padding:10px;border-radius:8px;border:1px solid #eee">
  </div>
  <div id="productsGrid" class="post-grid"></div>
  <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
    <button id="prevBtn" class="primary">Prev</button>
    <div id="pageInfo" style="font-weight:700"></div>
    <button id="nextBtn" class="primary">Next</button>
  </div>
</div>

<script>
const role = localStorage.getItem('role');
if (role === 'admin') document.getElementById('navAdmin').style.display = 'inline';
const logoutBtn = document.getElementById('logoutBtn');
logoutBtn.onclick = () => { localStorage.removeItem('token'); localStorage.removeItem('role'); localStorage.removeItem('userId'); localStorage.removeItem('userEmail'); localStorage.removeItem('userName'); window.location='login.html'; };

let all = [];
let currentList = [];
let currentPage = 0;
const PAGE_SIZE = 4; // 2x2 per page
async function loadProducts(){
  try{
    const res = await fetch('/posts');
    all = await res.json();
    currentList = all.slice();
    currentPage = 0;
    renderPage(currentPage);
  }catch(err){ console.error(err); document.getElementById('productsGrid').innerText='Error loading products'; }
}

function renderPage(page){
  const el = document.getElementById('productsGrid');
  const start = page * PAGE_SIZE;
  const slice = currentList.slice(start, start + PAGE_SIZE);
  if(!slice.length) { el.innerText='No products'; document.getElementById('pageInfo').innerText = '0 / 0'; return; }
  el.innerHTML = slice.map(p=>`
    <div class="post">
      ${p.image?`<img class="thumb" src="${p.image}" alt="${p.title}">`:''}
      <h3>${escapeHtml(p.title)}</h3>
      <div>Price: $${p.price||0}</div>
      <p>${escapeHtml(p.content).slice(0,120)}</p>
      <div style="margin-top:8px"><a href="post.html?id=${p._id}">See more</a></div>
    </div>
  `).join('');
  const total = Math.ceil(currentList.length / PAGE_SIZE) || 1;
  document.getElementById('pageInfo').innerText = `${page+1} / ${total}`;
  document.getElementById('prevBtn').disabled = page <= 0;
  document.getElementById('nextBtn').disabled = page >= total-1;
}

function escapeHtml(unsafe){ return unsafe? unsafe.replace(/[&<>\"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])):'' }

document.getElementById('search').oninput = function(e){
  const q = (e.target.value||'').toLowerCase();
  if(!q) { currentList = all.slice(); currentPage = 0; return renderPage(currentPage); }
  currentList = all.filter(p=> (p.title||'').toLowerCase().includes(q) || (p.content||'').toLowerCase().includes(q));
  currentPage = 0;
  renderPage(currentPage);
}

document.getElementById('prevBtn').onclick = function(){ if(currentPage>0){ currentPage--; renderPage(currentPage); } };
document.getElementById('nextBtn').onclick = function(){ const total = Math.ceil(currentList.length / PAGE_SIZE); if(currentPage< total-1){ currentPage++; renderPage(currentPage); } };

loadProducts();
</script>
</body>
</html>
