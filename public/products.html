<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Products - Food store</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<nav class="site-nav">
  <div class="nav-brand">Food store</div>
  <div>
    <a href="index.html">Home</a>
    <a id="navAdmin" href="admin.html" style="display:none">Admin</a>
    <a id="logoutBtn" href="#">Logout</a>
  </div>
</nav>

<div class="container">
  <h2>Available Products</h2>
  <div style="margin-bottom:12px">
    <input id="search" placeholder="Search products..." style="width:100%;padding:10px;border-radius:8px;border:1px solid #eee">
  </div>
  <div id="productsGrid" class="post-grid"></div>
</div>

<script>
const role = localStorage.getItem('role');
if (role === 'admin') document.getElementById('navAdmin').style.display = 'inline';
const logoutBtn = document.getElementById('logoutBtn');
logoutBtn.onclick = () => { localStorage.removeItem('token'); localStorage.removeItem('role'); localStorage.removeItem('userId'); localStorage.removeItem('userEmail'); localStorage.removeItem('userName'); window.location='login.html'; };

let all = [];
async function loadProducts(){
  try{
    const res = await fetch('/posts');
    all = await res.json();
    render(all);
  }catch(err){ console.error(err); document.getElementById('productsGrid').innerText='Error loading products'; }
}

function render(list){
  const el = document.getElementById('productsGrid');
  if(!list.length) { el.innerText='No products'; return; }
  el.innerHTML = list.map(p=>`
    <div class="post">
      ${p.image?`<img class="thumb" src="${p.image}" alt="${p.title}">`:''}
      <h3>${escapeHtml(p.title)}</h3>
      <div>Price: $${p.price||0}</div>
      <p>${escapeHtml(p.content).slice(0,120)}</p>
      <div style="margin-top:8px"><a href="post.html?id=${p._id}">See more</a></div>
    </div>
  `).join('');
}

function escapeHtml(unsafe){ return unsafe? unsafe.replace(/[&<>\"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])):'' }

loadProducts();

document.getElementById('search').oninput = function(e){
  const q = (e.target.value||'').toLowerCase();
  if(!q) return render(all);
  const f = all.filter(p=> (p.title||'').toLowerCase().includes(q) || (p.content||'').toLowerCase().includes(q));
  render(f);
}
</script>
</body>
</html>
